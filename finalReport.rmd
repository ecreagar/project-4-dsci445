---
title: "Final Report"
author: "Ethan, Kilbourne, Michael"
date: "12/13/2021"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(445)

# Installing a bunch of packages
library(ggplot2)
library(dplyr)
library(GGally)
library(ISLR)
library(caret)
library(MASS)
library(class)
library(knitr)
library(leaps)
library(glmnet)
library(boot)
library(gam)
library(tree)
library(gbm)
library(randomForest)
library(e1071)
library(splines)
```


# xYAF: A Metric for Evaluating Punt Returns

## Part 1: Motivation

Every year, the NFL hosts its annual Big Data bowl $^{[1]}$, in which members of the analytics community are able to submit ideas for new metrics, methods of quantifying performance, and other analytical measures that allow the football community to better understand the game from a data-driven perspective. As part of the 2022 NFL Big Data Bowl, which focused on special teams plays, we designed and implemented a new metric called xYAF, short for expected yards after fielding. Using this metric, we hope to provide a method for quantifying the effectiveness of punt returners against a neutral baseline, as well as examine the circumstances of a specific return.

In the creation of our metric, we took inspiration from the recent trend of "expected" statistics in sports analytics. There are many popular examples of these metrics, including expected goals $^{[2]}$ and expected assists in soccer, expected possession value in basketball $^{[3]}$, and expected yards after catch in football $^{[4]}$. Though these metrics span across many sports and parts of each sport, they generally share a common goal: providing an objective baseline to evaluate their part of the sport. By making a prediction for an event based on what has happened in the past given similar circumstances, we are able to understand the situation in an objective way.

Our xYAF metric, like other expected metrics, will take into account the current game state to attempt to accurately predict the number of yards gained by a punt returner. We will use all of the relevant information possible to make our prediction, including the location of the punt, location that the punt was fielded, locations of all of the kicking team and receiving team's players at the time of the catch, and the hang time of the punt. By accounting for all of these factors and creating a prediction, we hope to provide a neutral baseline for evaluation of punt returners as well as individual returns. 

We hope to create a method for evaluating returns which is better than any naïve method of examining returns or returners, such as looking at raw average return yards for a returner. Though this naïve method may seem like a good way of evaluating a returner, the nature of sports is such that many factors may cause an individual or team to perform better in a specific area (like punt returning). If we were to use raw average yards gained as a proxy for returner ability, we would be ignoring many important factors that affect a punt return. For example, when a team punts the ball from further into their own half of the field, the punter would likely punt the ball as far as possible, as the team would be trying to gain maximal yards and field position with the punt. However, when punting the ball in or near the opponent's half, the punter might try to punt the ball a fewer number of yards to "pin" the team close to their own end zone and avoid a touchback. For this reason, if a punt returner plays on a team with a better defense, who stops the opponent deeper into their own side of the field more often, they will likely receive the ball further away from the location of the punt more often. This will mean that the punting team has further to run to tackle the punt returner, allowing the returner to gain more yards on average as a result. This is an example of an indirect influence that is not in the hands of the returner, and should therefore not influence his reputation as a returner. By providing a baseline that takes into account punt location, fielding location, and defender and blocker locations when the ball is caught, our model will predict more xYAF in the case of a longer punt where the defenders are further away from the returner when the ball is caught, and fewer yards in the case of a short punt with nearby defenders. We can then evaluate punt returners across teams and systems according to this baseline.

The creation of our data set requires a large amount of data cleanup. The data originally comes in several files containing the tracking data as well as list of plays over the 2018, 2019, and 2020 NFL seasons. The tracking data originally contains location, direction, and other information for each player at each frame relevant to a special teams play. Since there are about 20,000 plays with 22 players each, and each play contains roughly 50 frames, we are have $20000 * 22 * 50 = 22,000,000$ rows to start with between the three tracking data files. After trimming only the returned punts from the data and combining information about each punt, field, and tackle frame to retain only relevant information, we are left with about 2,000 punts to predict with. 


## Part 2: Methodology

We should talk about models used, feature engineering we had to do, and dropping outliers.

## Part 3: Results

Results with and without outliers, which model ended up working the best, and fine tuning that model further with CV in order to get the minimum possible MSE (translate to yards as well).

## Part 4: Conclusion

- Final model evaluated on specific punts as well as a list of returners by performance compared to xYAF
- Problem difficulties (skewed distribution, sometimes accurate predictions aren't even desired)
- Future goals (usefulness, ideas to improve accuracy).
  - something that would be cool for the future is a confidence metric that we could model likelihood on. For example, if a returner got 30 yards on a punt where 5 was expected, we could look at the likelihood of that return happening.
- might there be a better error metric? Something like SMAPE (symmetric mean average percentage error) might work well, so that a prediction 5 yards off on a short punt return is punished more harshly than 5 yards off on a larger punt return.

To evaluate the effectiveness and demonstrate the usefulness of our model, we can apply it to both individual punts as well as evaluate punt returners based on their consistent performance against our predictions. We will first apply the model to individual punt returns, where we will demonstrate how the model would be used in such a case.

The first punt return we will examine takes place between Seattle and San Francisco on November 11th, 2019. Seattle punts the ball from their own 25 yard line. The punt travels all the way to the opponent's 25 yard line before being fielded by Richie James Jr. of the 49ers. When James Jr. catches the ball, he has quite a few defenders close to him, the closest being 6 yards away, and three being fewer 10 yards away. James Jr. does not get very far, losing his balance and succumbing to the defense after only gaining 1.5 yards.


```{r, echo = FALSE, out.width="33.3%"}
myimages<-list.files("Images/puntreturn1/", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

Out model considers all of the relevant information above for this return, and is able to make a very good prediction, predicting 1.52 yards, just 0.06 fewer than the actual return of 1.58 yards. This is an example of a fairly normal punt return, which is likely why our model is able to predict very well in this scenario.

```{r, echo = FALSE, out.width="33.3%"}
myimages<-list.files("Images/puntreturn1/", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

We can evaluate a second, less common punt return where our model struggles to make an accurate prediction. This return took place between the Pittsburgh Steelers and Arizona Cardinals in Week 14 of the 2019 season. The Cardinals punt from their own 15 yard line, and after a very long punt Diontae Johnson fields the punt at the Steelers 15 yard line. The closest defender is 11 yards away, but there are hardly any defenders nearby other than him and the Steelers have a blocker near this defender. Johnson is able to evade the entire defense, taking the punt back for an 85 yard touchdown.


```{r, echo = FALSE, out.width="33.3%"}
myimages<-list.files("Images/puntreturn2/", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

Our model makes a very poor prediction of 4.8 yards for this punt return, assuming that Johnson will be tackled by either the first defender or soon after. This contributes $(85-4.8)^2 \approx 6400$ units worth of squared error to our results, which is an example of why our MSE is much better after filtering outliers like this punt.

Another use case for our model is evaluating many punts by many different returners and evaluating which returners tend to beat the predictions by the most yards. As mentioned in the Motivation section, this may be preferred to a naïve average return yards metric for measuring returner performance, because our metric is able to account for many factors that go into a punt and evaluate all players on the same baseline. To implement xYAF for evaluating returners, we run our best Ridge model on every punt in the three years worth of data. We make predictions on every punt, take the difference between the actual return and the predicted return, and use this as a measurement for kick returner effectiveness when averaged over every all of the returns. Below are the top 10 punt returners (minimum 10 returns) based on $actual - xYAF$.

```{r, echo = F}
res <- read.csv('results_vs_expected.csv') %>% rename(avg_actual_minus_pred = avg_error, punts_returned = count)
players <- read.csv('Data/players.csv') %>% rename(player = nflId)
players$player = as.character(players$player)

res <- res %>% left_join(players, by='player')

res %>%
  dplyr::select(displayName, avg_actual_minus_pred, punts_returned) %>%
  filter(punts_returned >= 10) %>% 
  head(10) %>%
  kable()
```

These 10 players consistency outperform their predicted yards after catch by the most. The best among them is DeAndre Carter, a Wide Receiver for the Washington Football Team. Carter averages 6.5 more yards per return than would be expected. Examining Carter's statistics, he averages about 9.4 yards per return over his NFL career $^{[5]}$, which is good but not outstanding. However, as mentioned in the Motivation section, we would expect a player who generally receives the ball with less space to average less return yards, and having less space results from the opponent having longer drives and punting the ball from further down the field which would imply that the returner played for a poor defense. In the 2018 and 2019 seasons where Carter made over 75% of his punt returns, Washington's defense ranked 17th and 27th respectively in yards allowed by opponents $^{[6}}$. These years were also Carter's best two seasons of returning, where he averaged 9.6 and 9.7 yards per game, respectively $^{[5]}$. This is a great example of the usefulness of xYAF, because while Carter's numbers may not be the highest in raw average return yards (Carter's Football Team ranked 25th and 32nd in these two seasons, respectively $^{[6]}$), he is a much better punt returner than those numbers show.

Worst Returners:

```{r, echo = F}
res %>%
  dplyr::select(displayName, avg_actual_minus_pred, punts_returned) %>%
  filter(punts_returned >= 10) %>% 
  tail(10) %>%
  kable()
```




## Works Cited

[1] https://operations.nfl.com/gameday/analytics/big-data-bowl/

[2] Sam Green. Assessing the performance of Premier League goalscorers. Stats Perform, 2012.

[3] https://grantland.com/features/expected-value-possession-nba-analytics/

[4] https://www.nfl.com/news/next-gen-stats-intro-to-expected-yards-after-catch-0ap3000000983644

[5] https://www.pro-football-reference.com/players/C/CartDe02.htm

[6] https://www.footballdb.com/stats/teamstat.html?lg=NFL&yr=2018&type=reg&cat=T&group=D&conf=


